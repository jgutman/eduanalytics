title: "Admissions internal process data"
author: "Jacqueline Gutman, Suvam Paul"
date: 'Last updated: `r format(Sys.Date(), "%B %d, %Y") ` '
output:
  html_document:
    toc: yes
    toc_depth: '4'
  html_notebook:
    highlight: tango
    theme: cosmo
    toc: yes
    toc_depth: 4
---

```{r, message = FALSE}
library(tidyverse)
library(magrittr)
library(knitr)
library(stringr)
library(readxl)

opts_chunk$set(message = FALSE, warning = FALSE, comment = "   ",
               cache = TRUE, autodep = TRUE, cache.comments = FALSE)

parent_path <- "/Volumes/IIME/EDS/data/admissions/data_documentation_from_lisa_admissions"
admissions_path <- paste(parent_path, "Data", sep = "/")
(raw_files <- list.files(admissions_path, full.names = TRUE))
```

```{r, warning = FALSE, eval = FALSE}
raw_files %>% 
  str_detect(regex("/\\d{4} all applicants", ignore_case = TRUE)) %>%
  which() %>% extract(raw_files, .) %>%
  purrr::map(function(path) readxl::read_excel(path)) %>%
  set_names(2013:2016) -> applicants_data

# Make sure the column names in the 4 dataframes are all identical
applicants_data %>% map(colnames) %>% {all.equal(.$`2013`, .$`2014`)}
applicants_data %>% map(colnames) %>% {all.equal(.$`2013`, .$`2015`)}
applicants_data %>% map(colnames) %>% {all.equal(.$`2013`, .$`2016`)}

# Extract the data type for each column in each data frame
coltypes_df <- applicants_data %>% 
  at_depth(2, class) %>% 
  at_depth(2, extract(1)) %>% 
  as_data_frame() %>% 
  unnest()

single_value <- function(a) {
  length(unique(a)) == 1
}

coltypes_df <- coltypes_df %>%
  mutate_all(funs(str_replace_all(., 
        c("character" = "text", "POSIXct" = "date")))) %>%
  invoke_rows(c, ., .collate = "list", .to = "coltypes") %>%
  mutate(colname = colnames(applicants_data[[1]]),
         agreement = map_lgl(coltypes, single_value),
         coltypes_factor = map(coltypes, function(.x) {
           factor(.x, levels = c("numeric", "text", "date"), ordered = TRUE)})) %>%
  mutate(primary_coltype = map_chr(coltypes_factor, 
            function(.x) {as.character(max(.x))})) 

documentation_path <- paste(parent_path, "Documentation", "coltypes_admissions.csv", sep = "/")
coltypes_df %>% select(colname, primary_coltype) %>% write_csv(documentation_path)
```


```{r}
documentation_path <- paste(parent_path, "Documentation", "coltypes_admissions.csv", sep = "/")
coltypes_df <- read_csv(documentation_path)

# raw_files <- list.files("~/Desktop/Box Sync/Data for Admissions/", full.names = TRUE)
```


```{r, message = FALSE, warning = FALSE}
raw_files %>% 
  str_detect(regex("/\\d{4} all applicants", ignore_case = TRUE)) %>%
  which() %>% extract(raw_files, .) %>%
  purrr::map(function(path) readxl::read_excel(path, col_types = coltypes_df$primary_coltype)) %>%
  set_names(2013:2016) -> applicants_data

applicants_all_years <- bind_rows(applicants_data)
applicants_2013 <- applicants_data$`2013`
applicants_2014 <- applicants_data$`2014`
applicants_2015 <- applicants_data$`2015`
applicants_2016 <- applicants_data$`2016`

colnames(applicants_all_years)

id_columns <- c("amcas_id", "app_year")
tracking_columns <- c("appl_submit_date",
                      "appl_complete_date",
                      "screening_complete_date",
                      "interview_invite_date",
                      "interview_schedule_date",
                      "interview_day",
                      "interview_complete_date",
                      "committee_date",
                      "offer_date",
                      "accept_date")
```

```{r}
filter_applications <- . %>%
  # filter out M.D./Ph.D. applicants, special programs (i.e. linkages), and 
  # deferred applicants from previous years
  filter(appl_type_desc %in% c("Regular M.D.", "Combined  Medical Degree/Graduate")) %>%
  filter(!is.na(appl_submit_date) & !is.na(appl_complete_date))

n_applications_by_phase <- function(applications) {
  applications %>%
    mutate(n_total_applications = map_int(total_applications, nrow),
           screening_eligible = map(total_applications, filter_applications),
           n_screening_eligible = map_int(screening_eligible, nrow),
           faculty_screened = map(screening_eligible, function(df)
             filter(df, !is.na(scr_dec))),
           n_faculty_screened = map_int(faculty_screened, nrow)) ->
    screened_applications
    
}

applicants_all_years %>% 
  group_by(app_year) %>% 
  nest(.key = total_applications) -> nested_applicants

nested_applicants %>% 
  n_applications_by_phase %>%
  select(n_total_applications, n_screening_eligible, n_faculty_screened)
```

```{r}
application_status_by_month <- . %>% 
  filter_applications() %>% 
  extract(tracking_columns) %>%
  gather(event, date, na.rm = TRUE) %>% 
  mutate(month = lubridate::month(date),
         year = lubridate::year(date)) %>%
  group_by(event, year, month) %>%
  summarize(count = n()) %>%
  spread(event, count, fill = 0) %>%
  select(month, year, one_of(tracking_columns))

applicants_2016 %>% application_status_by_month
```


```{r}
expand.grid(screener1 = 1:3, screener2 = 1:3) %>%
  mutate(scr_dec = screener1 + screener2,
         screener_sd = purrr::map2_dbl(screener1, screener2, 
                                       function(a, b) sd( c(a, b) )
                                       ))
```

