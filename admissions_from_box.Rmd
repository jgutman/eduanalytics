title: "Admissions internal process data"
author: "Jacqueline Gutman, Suvam Paul"
date: 'Last updated: `r format(Sys.Date(), "%B %d, %Y") ` '
output:
  html_document:
    toc: yes
    toc_depth: '4'
  html_notebook:
    highlight: tango
    theme: cosmo
    toc: yes
    toc_depth: 4
---

```{r, message = FALSE}
library(tidyverse)
library(magrittr)
library(knitr)
library(stringr)
library(readxl)

opts_chunk$set(message = FALSE, warning = FALSE, comment = "   ",
               cache = TRUE, autodep = TRUE, cache.comments = FALSE)

admissions_path <- "/Volumes/IIME/EDS/data/admissions/data_documentation_from_lisa_admissions/Data" 
(raw_files <- list.files(admissions_path, full.names = TRUE))
```

```{r, eval = FALSE}
applicants_data <- purrr::map(seq(from = 1, by = 3, length.out = 4),
              function(i) readxl::read_excel(raw_files[i])) %>%
  set_names(2013:2016)

# Make sure the column names in the 4 dataframes are all identical
applicants_data %>% map(colnames) %>% {all.equal(.$`2013`, .$`2014`)}
applicants_data %>% map(colnames) %>% {all.equal(.$`2013`, .$`2015`)}
applicants_data %>% map(colnames) %>% {all.equal(.$`2013`, .$`2016`)}

# Extract the data type for each column in each data frame
coltypes_df <- applicants_data %>% 
  at_depth(2, class) %>% 
  at_depth(2, extract(1)) %>% 
  as_data_frame() %>% 
  unnest()

coltypes_df <- coltypes_df %>%
  mutate_all(funs(str_replace_all(., 
        c("character" = "text", "POSIXct" = "date")))) %>%
  invoke_rows(c, ., .collate = "list", .to = "coltypes") %>%
  mutate(colname = colnames(applicants_data[[1]]),
         agreement = map_lgl()) 

```

```


```{r}


coltypes <- c("numeric", "numeric", rep("text", 10), "date", "text", "text",
              rep("numeric", 5), rep("text", 6), "numeric", "numeric", "date",
              "numeric", "numeric", "text", "text", "text", "numeric", "text", 
              "date", "text", "text", rep("date", 10), "text",
              "numeric", "numeric", "text", "text", "numeric", "text", "text",
              "date", "text", "numeric", "text", "numeric", "numeric", "text",
              "text", "numeric", "text", "text", "text", "date", "numeric", 
              "text", "text", rep("numeric", 6), "text", "text", )
              
```


```{r, message = FALSE, warning = FALSE}

applicants_data <- purrr::map(seq(from = 1, by = 3, length.out = 4),
              function(i) readxl::read_excel(raw_files[i])) %>%
  set_names(2013:2016)

applicants_2013 <- applicants_data$`2013`
applicants_2014 <- applicants_data$`2014`
applicants_2015 <- applicants_data$`2015`
applicants_2016 <- applicants_data$`2016`

id_columns <- c("amcas_id", "app_year")
tracking_columns <- c("appl_submit_date",
                      "appl_complete_date",
                      "screening_complete_date",
                      "interview_invite_date",
                      "interview_schedule_date",
                      "interview_day",
                      "interview_complete_date",
                      "committee_date",
                      "offer_date",
                      "accept_date")

colnames(applicants_2013)
```

```{r}

```


```{r}
filter_applications <- . %>%
  # filter out M.D./Ph.D. applicants, special programs (i.e. linkages), and 
  # deferred applicants from previous years
  filter(appl_type_desc %in% c("Regular M.D.", "Combined  Medical Degree/Graduate")) %>%
  filter(!is.na(appl_submit_date) & !is.na(appl_complete_date))

n_applications_by_phase <- function(applicants) {
  
}

applicants_2013 %>% nrow()  
applicants_2013 %>% filter_applications() %>% nrow()
applicants_2013 %>% filter_applications() %>%
  filter(!is.na(scr_dec)) %>% nrow()
```

```{r}
application_status_by_month <- . %>% 
  filter_applications() %>% 
  extract(tracking_columns) %>%
  gather(event, date, na.rm = TRUE) %>% 
  mutate(month = lubridate::month(date),
         year = lubridate::year(date)) %>%
  group_by(event, year, month) %>%
  summarize(count = n()) %>%
  spread(event, count, fill = 0) %>%
  select(month, year, one_of(tracking_columns))

applicants_2016 %>% application_status_by_month
```


```{r}
expand.grid(screener1 = 1:3, screener2 = 1:3) %>%
  mutate(scr_dec = screener1 + screener2,
         screener_sd = purrr::map2_dbl(screener1, screener2, 
                                       function(a, b) sd( c(a, b) )
                                       ))
```

