---
title: "Upload deidentified outcomes data and new features"
author: "Jacqueline Gutman, Suvam Paul"
date: 'Last updated: `r format(Sys.Date(), "%B %d, %Y") ` '
output:
  html_document:
    toc: yes
    toc_depth: '4'
  html_notebook:
    highlight: tango
    theme: cosmo
    toc: yes
    toc_depth: 4
---

# Setup
## Load packages
## Read in database credentials and open connection

```{r setup, message=FALSE, echo = FALSE}
knitr::read_chunk("setup_notebook.R")
```

```{r setup_notebook}
```

```{r show_pkgs, echo = FALSE}
print_loaded_pkgs()
```

# Upload deidentified outcomes from flat text file

```{r data_dirs}
parent_path <- "/Volumes/IIME/EDS/data/admissions"
(data_dirs <- list.dirs(parent_path, full.names = TRUE, recursive = FALSE))
```

```{r}
data_dirs %>%
  str_detect("outcome_data") %>%
  magrittr::extract(data_dirs, .) %>%
  list.files(full.names = TRUE) -> outcome_data
```

```{r}
outcome_data %>%
  str_detect("version_3") %>%
  magrittr::extract(outcome_data, .) %>%
  fread(na.strings = "NULL") -> outcome_data
```

```{r}
outcome_data %>%
  write_to_database_single(edu_db_con, "deidentified$outcome$outcomes_plus_features")
```

```{r}
get_outcome_valid_years <- function(outcome_name, data, year_range) {
  data %>%
    select(one_of("study_id", "appl_year", outcome_name)) %>%
    filter(appl_year >= year_range[[outcome_name]]$min_year,
          appl_year <= year_range[[outcome_name]]$max_year) %>%
    set_names(c(colnames(.)[-3], "outcome"))
}
```


```{r}
outcome_year_range <- yaml::yaml.load_file("outcomes.yaml")
```

```{r}
outcome <- "aoa"

outcome %>%
  get_outcome_valid_years(outcome_data, outcome_year_range) %>%
  replace_na(list(outcome = 0)) %>%
  write_to_database_single(edu_db_con, add_tbl_prefix(outcome, status = "outcome"))
```

