---
title: "Upload deidentified outcomes data and new features"
author: "Jacqueline Gutman, Suvam Paul"
date: 'Last updated: `r format(Sys.Date(), "%B %d, %Y") ` '
output:
  html_document:
    toc: yes
    toc_depth: '4'
  html_notebook:
    highlight: tango
    theme: cosmo
    toc: yes
    toc_depth: 4
---

# Setup
## Load packages
## Read in database credentials and open connection

```{r setup, message=FALSE, echo = FALSE}
knitr::read_chunk("setup_notebook.R")
```

```{r setup_notebook}
```

```{r show_pkgs, echo = FALSE}
print_loaded_pkgs()
```

# Upload deidentified outcomes from flat text file

```{r data_dirs}
parent_path <- "/Volumes/IIME/EDS/data/admissions"
(data_dirs <- list.dirs(parent_path, full.names = TRUE, recursive = FALSE))
```

```{r}
data_dirs %>%
  str_detect("outcome_data") %>%
  magrittr::extract(data_dirs, .) %>%
  list.files(full.names = TRUE) -> outcome_data
```

```{r}
outcome_data %>%
  str_detect("version_3") %>%
  magrittr::extract(outcome_data, .) %>%
  fread(na.strings = "NULL") -> outcome_data
```

```{r}
outcome_data %>%
  write_to_database_single(edu_db_con, "deidentified$outcome$outcomes_plus_features")
```

```{r}
filter_valid_years <- function(outcome_name, data, year_range) {
  outcome <- outcome_name[1]
  
  data %>%
    select(study_id, appl_year, one_of(outcome_name)) %>%
    filter(appl_year >= year_range[[outcome]]$min_year,
          appl_year <= year_range[[outcome]]$max_year)
}

get_outcome_valid_years <- function(outcome_name, data, year_range) {
   filter_valid_years(outcome_name, data, year_range) %>%
    set_names(c(colnames(.)[-3], "outcome"))
}
```

```{r}
outcome_year_range <- yaml::yaml.load_file("outcomes.yaml")
```

```{r}
outcomes <- c("aoa", "residency_top_25_school")

outcomes %>%
  map(function (outcome) get_outcome_valid_years(outcome, outcome_data, outcome_year_range)) %>%
  map(function(df) replace_na(df, list(outcome = 0))) %>%
  map2_lgl(outcomes, function (df, outcome) write_to_database_single(
                                        df, edu_db_con, add_tbl_prefix(outcome, status = "outcome")))
```

```{r}
outcomes <- c("step1_score", "step2_score")

outcomes %>%
  map(function (outcome) get_outcome_valid_years(outcome, outcome_data, outcome_year_range)) %>%
  map2_lgl(outcomes, function (df, outcome) write_to_database_single(
                                        df, edu_db_con, add_tbl_prefix(outcome, status = "outcome")))
```

```{r}
get_percent_outcomes <- function(outcomes, data, year_range, percent_cutoff) {
  dots <- lazyeval::interp(~ count / total, 
                  count = as.name(outcomes[1]),
                  total = as.name(outcomes[2]))
  
  outcomes %>%
    filter_valid_years(data, year_range) %>%
    mutate_(.dots = list(pct = dots)) %>%
    mutate(outcome = as.numeric(pct <= percent_cutoff)) %>%
    select(-one_of(outcomes, "pct")) 
}
```

```{r}
outcomes <- list(c("clerkship_honors_count", "clerkship_count"),
                 c("shelf_exam_above90_count", "shelf_exam_count"),
                 c("school_exam_above90_count", "school_exam_count"))
thresholds <- list(.20, .40, .20)

outcomes %>% 
  map2(thresholds, function(outcome, threshold) get_percent_outcomes(
              outcome, outcome_data, outcome_year_range, 
                        percent_cutoff = threshold)) %>%
  map2_lgl(outcomes, function (df, outcome) write_to_database_single(
                                    df, edu_db_con, add_tbl_prefix(outcome[1], status = "outcome")))
```

```{r}
outcomes <- c("course_clerkships_failed_count", 
              "shelf_exam_below65_count",
              "school_exam_below65_count")

outcomes %>% 
  map(function(outcome) get_outcome_valid_years(outcome, outcome_data, outcome_year_range)) %>%
  map(function(df) mutate(df, outcome = outcome >= 1)) %>%
  map2_lgl(outcomes, function (df, outcome) write_to_database_single(
                                    df, edu_db_con, add_tbl_prefix(outcome, status = "outcome")))
```

```{r}
outcome_data %>%
  select(study_id, appl_year, gender, age_at_application, college_top_25, 
         is_disadvantaged, urm, advanced_degree, 
         race = race_text, total_num_schools_accepted_to) %>%
  write_to_database_single(edu_db_con, add_tbl_prefix("other_features", status = "generated"))
```

```{r}
in_school_columns <- c("clerkship_honors_count", 
                       "course_clerkships_failed_count",
                       "shelf_exam_below65_count", 
                       "shelf_exam_above90_count", 
                       "school_exam_below65_count",
                       "school_exam_above90_count")

outcome_data %>%
  select(study_id, appl_year, one_of(in_school_columns)) -> in_school_data

replace_invalid_year <- function(data, outcome_name, year_range) {
  dots <- lazyeval::interp(~ if_else(
      (appl_year >= min_year) &
      (appl_year <= max_year),
    col, NA_integer_),
    min_year = year_range[[outcome_name]]$min_year,
    max_year = year_range[[outcome_name]]$max_year,
    col = as.name(outcome_name))
    
  data %>%
    mutate_(.dots = set_names(list(dots), outcome_name))
}

reduce(in_school_columns, replace_invalid_year, 
       year_range = outcome_year_range,
      .init = in_school_data) -> in_school_data
```

```{r}
in_school_data %>%
  write_to_database_single(edu_db_con, add_tbl_prefix("in_school_performance", status = "generated"))
```

