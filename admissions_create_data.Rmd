title: "Admissions dataset generation"
author: "Jacqueline Gutman, Suvam Paul"
date: 'Last updated: `r format(Sys.Date(), "%B %d, %Y") ` '
output:
  html_document:
    toc: yes
    toc_depth: '4'
  html_notebook:
    highlight: tango
    theme: cosmo
    toc: yes
    toc_depth: 4
---


About the problem: 


About the data: 

The MCAT and GPA data are available from application years 2006-2017 and MMI data is available for application years 2013-2017. However, interview, acceptance, and matriculation data are available for 2013-2017, please use these years in the analysis. Please note that 2017 application year is still in progress. 

The variable "aamc_id" is the unique identfier for each applicant. This variable can be used to merge across these datasets. Please note that the applicants have applied to the medical school in multiple application years. The first time they applied, they might have been rejected or withdrew the application, only to apply again in a later application year and was accepted. In that case, the combination of aamc_id and application year each will uniquely identify each applicant (applicants are allowed to apply only once in an application year). 
 
There are two MCAT datsets as the format of the MCAT changed a few years ago. Applicants also took the MCAT multiple times. The MCAT datasets has the "date" variable that indicates when they took the exam as well as the "rank" variable that indicates the order of the MCATs (MCAT with rank is the latest MCAT for that applicant). Additional features will need to be built for analysis, for example, the MCAT score at the time of FIRST application to NYU School of Meidicine (applicants have applied many times). This can be calculated from looking at the application dataset to see when an applicant first applied and determine the staus of her application (rejected or accepted) using the aamc_id and application year. Then you can match this infomration with the MCAT scores at the time of application in one of the MCAT datasets (again using aamc_id and application year).  

Finally, from our discussions with admissions team, we found that Regular M.D. applicants undergo a very different process than the combined PhD/MD applicants. Therefore, we recommend that from the applicant datasets remove any applicant who is a Phd/MD applicants (from the "program_name" variable), and to keep using this filter as you combine datasets. 


Datasets: 

Application 
Committee 
Ethnicity 
Race
MMI Scores - MMI interview scores, application year 2013-2017
GPA - the GPA across many schools they attended by the applicants
School - the schools attended by the applicants


```{r, message = FALSE}
library(tidyverse)
library(magrittr)
library(knitr)
library(stringr)

opts_chunk$set(message = FALSE, warning = FALSE, comment = "   ",
               cache = TRUE, autodep = TRUE, cache.comments = FALSE)

#list.dirs("/Volumes/", full.names = TRUE, recursive = FALSE)
#admissions_path <- "/Volumes/admissions" 
admissions_path <- "/Volumes/IIME/EDS/data/admissions" 
(raw_files <- list.files(admissions_path, full.names = TRUE))
```


```{r, message = FALSE}
extract_data <- function(file_list, pattern) {
  file_list %>%
    str_detect(regex(pattern, ignore_case = TRUE)) %>%
    which() %>%
    extract2(file_list, .) %>%
    read_csv() %>%
    set_colnames(tolower(colnames(.)))
}

applications <- raw_files %>%
  extract_data("/application") %>%
  select(-first_name, -last_name)


table(applications$appl_year)
#2006-2017

table(applications$application_status)
#Create accepted from Marticulated and Withdrawn after accepted! 


#create accepted
create_accepted_variable <- function(type) {
  switch(type, 
         "Accepted" = "Accepted",
         "Withdrawn after acceptance" = "Accepted",
         "Rescinded acceptance" = "Accepted", 
         "Matriculated" = "Accepted",
         "Other"
         )
}

applications <- applications %>% 
  mutate(accepted = purrr::map_chr(application_status, create_accepted_variable))
table(as.factor(applications$application_status), as.factor(applications$accepted))



#what does a repeated applications look like? 
app_repeated_count <- applications %>% 
  group_by(aamc_id) %>% 
  summarise(count_num = n()) %>% 
  filter(count_num > 1) %>% 
  arrange(aamc_id) %>% 
  ungroup()

applications_rep_info <- left_join(applications, app_repeated_count, by = "aamc_id")
applications_rep_info <- applications_rep_info %>% arrange(aamc_id, desc(appl_year))

applications_rep_info_14_17 <- applications_rep_info %>% filter(appl_year == 2014 | appl_year == 2015 | appl_year == 2016 | appl_year == 2017)

applications_rep_info_14_17_non_null_numcount <- applications_rep_info_14_17 %>% 
  filter(count_num == 2 | count_num == 3) %>% arrange(aamc_id)

applications_rep_info_14_17_non_null_numcount_accepted <- applications_rep_info_14_17_non_null_numcount %>% filter(application_status == "Accepted")


##Thoughts
#How do I handle applications in multiple years? 
    #--combine year and aamc_id?


```


```{r}

applications %>%
  filter(program_name == "Regular M.D.") %>%
  group_by(appl_year, application_status) %>%
  summarize(count = n()) %>%
  spread(application_status, count, fill = 0)


#Types of aplication status

#Accepted
#Alternate list
#Deferred to future class
#Matriculated
#No action

```

```{r}
applications %>% 
  group_by(aamc_id) %>%
  summarize(n_times_applied = n_distinct(appl_year)) %>%
  group_by(n_times_applied) %>%
  summarize(n_applicants = n())
```


```{r, mcat_old}
mcat_old <- raw_files %>% 
  extract_data("/mcat") %>%
  set_colnames(stringr::str_replace(colnames(.), "_p$", "_percentile"))

#keep only distinct combinations of date and aamc_id
mcat_old2 <- mcat_old %>% 
  mutate(date = lubridate::dmy(test_date)) %>%
  distinct(aamc_id, date, .keep_all = TRUE)

#rank mcat by date taken
mcat_old2 <- mcat_old2 %>% 
  group_by(aamc_id) %>% 
  mutate(rank = rank(desc(date), ties = "min")) %>% 
  arrange(aamc_id, rank) %>% 
  ungroup()

names(mcat_old2)

```


```{r, mcat_new}
mcat_new <- raw_files %>% 
  extract_data("new_mcat")

head(mcat_new)

table(as.factor(mcat_new$appl_year))

names(mcat_new)

mcat_new <- mcat_new %>% 
  mutate(month_letter = parse_betweeen_first_second_dash(new_mcat_test_date), 
         month_number = purrr::map(month_letter, rename_month_to_number),
         date_number = parse_before_first_dash(new_mcat_test_date),
         year_number= parse_after_second_dash(new_mcat_test_date),
         date = lubridate::mdy(paste(month_number, date_number, year_number, sep = "/")))


mcat_new2 <- mcat_new %>% 
  distinct(aamc_id, date, .keep_all = TRUE)

mcat_new2 <- mcat_new2 %>% 
  group_by(aamc_id) %>% 
  mutate(rank = rank(desc(date), ties = "min")) %>% 
  arrange(aamc_id, rank) %>% 
  ungroup()


#write this file for new mcat scores
mcat_new2 <- mcat_new2 %>% 
  select(-(month_letter:year_number))

names(mcat_new2)
```


```{r, further_analysis_mcat_old_new}
#I have the latest old mcat for each person and the latest new mact for each person

#what if someone took an old mcat and new mcat? 

# first_mcat_old <- mcat_old2 %>% filter(rank == 1) %>% mutate(mcat_type = "old")
# first_mcat_new <- mcat_new2 %>% filter(rank == 1) %>% mutate(mcat_type = "new")
# 
# names(first_mcat_old)
# names(first_mcat_new)
# 
# sub_mcat_old <- first_mcat_old %>% dplyr::select(aamc_id, mcat_type, rank, appl_year)
# sub_mcat_new <- first_mcat_new %>% dplyr::select(aamc_id, mcat_type, rank, appl_year)
# 
# sub_mcat_both <- rbind(sub_mcat_old, sub_mcat_new)
# 
# sub_mcat_both <- sub_mcat_both %>% arrange(aamc_id)
# 
# sub_mcat_both_count <- sub_mcat_both %>% 
#   group_by(aamc_id, mcat_type) %>% 
#   summarise(count = n()) %>% 
#   arrange(aamc_id)
# 
# table(as.factor(sub_mcat_both_count$count))
# table(as.factor(sub_mcat_both_count$count), sub_mcat_both_count$mcat_type)
# 
# sub_mcat_both_count_wide <- sub_mcat_both_count %>% 
#   spread(mcat_type, count) 
# 
# sub_mcat_both_count_wide <- sub_mcat_both_count_wide %>%
#   filter(new ==1 & old == 1)
# 
# dim(sub_mcat_both_count_wide) 
# 
# #2518 applicants has both old and new mcats
# 
# 
# #compare the dates of the old and new mcats, and only take the the ones that has a latest, update the old and new mcat datases accordingly
# 
# old_mcat_dates <- left_join(sub_mcat_both_count_wide, final_mcat_old, by = "aamc_id") %>% 
#   dplyr::select(aamc_id, date) %>% 
#   rename(latest_old_mcat_date = date)
# 
# dim(old_mcat_dates)
# 
# new_mcat_dates <- left_join(sub_mcat_both_count_wide, final_mcat_new, by = "aamc_id") %>% 
#   dplyr::select(aamc_id, date) %>% 
#   rename(latest_new_mcat_date = date)
# 
# dim(new_mcat_dates)
# names(new_mcat_dates)
# 
# mcat_score_dates <- left_join(old_mcat_dates, new_mcat_dates) %>% 
#   mutate(old_mcat_latest = as.numeric(latest_old_mcat_date > latest_new_mcat_date), 
#          new_mcat_latest = as.numeric(latest_old_mcat_date < latest_new_mcat_date))
# 
# table(as.factor(mcat_score_dates$old_mcat_latest), as.factor(mcat_score_dates$new_mcat_latest))
# 
# 
# #For everyone who took both mcats, their latest mcat is the new one
# 
# #Therefore remove them from the old mcat dataset who has a new mcat score
# 
# #old mcat
# first_mcat_old <- left_join(first_mcat_old, mcat_score_dates) %>% 
#   filter(is.na(new_mcat_latest)) %>% 
#   dplyr::select(-mcat_type)
# names(first_mcat_old)
# 
# 
# #new mcat
# first_mcat_new <- first_mcat_new %>% 
#   dplyr::select(-mcat_type)
# names(first_mcat_new)
```


```{r, message = FALSE}

# mmi_full <- raw_files %>% 
#   extract_data("/mmi.csv")

```


```{r, message = FALSE}
# # get percent missing by column by year
# mmi_full %>%
#   group_by(app_year) %>%
#   summarize_all(funs(mean(is.na(.))))
# 
# 
# # all rows and applicants included
# mmi_full %>%
#   group_by(app_year) %>%
#   summarize(n = n(),
#             n_applicants = n_distinct(appl_person_id))
# 
# # non-null rows and applicants only
# mmi_full %>% 
#   group_by(app_year) %>% 
#   filter(!is.na(rank) | !is.na(interviewer_type)) %>%
#   summarize(n = n(), n_applicants = n_distinct(appl_person_id))
# 
# 
# #mmi dataset that's non-null and applicants only
# mmi_nonnull_applicants <- mmi_full %>% 
#     filter(!is.na(rank) | !is.na(interviewer_type)) %>% 
#   arrange(aamc_id)
# 

```


```{r, mmi}

#new mmi pull
mmi_pull_2 <- raw_files %>% 
  extract_data("/MMI_Scores_Admission")

mmi_pull_2 %>%
  group_by(app_year) %>%
  summarize_all(funs(mean(is.na(.))))


names(mmi_pull_2)[2] <- "aamc_id"
#write this dataset for final mmi dataset

table(mmi_pull_2$app_year)




#2013
#2 -> 4 Exceeds
#5 -> 1 Far below
#3 -> 3 Meets 
#1 -> 5 Far exceels
#4 -> 2 Below



recode_vars <- function(type) {
 switch(type,
        "1" = "5",
        "2" = "4",
        "3" = "3",
        "4" = "2",
        "5" = "1",
        "Not available")
}


mmi_pull_2 <- mmi_pull_2 %>% 
  mutate(rank = as.character(rank), rank = ifelse(app_year == 2013, purrr::map_chr(rank, recode_vars), rank))


```





```{r, committee}
committee <- raw_files %>% 
  extract_data("/Committee")

names(committee)

table(as.factor(committee$app_year))
#2012-2017 app year, committee decision for all applicants, regular and non interviews 

committee <- committee %>%
  arrange(aamc_id) 

committee %>% 
  group_by(aamc_id) %>%
  summarize(n_times_applied = n_distinct(app_year)) %>%
  group_by(n_times_applied) %>%
  summarize(n_applicants = n())


table(as.factor(committee$activity_text), as.factor(committee$faculty_activity))
table(as.factor(committee$activity_text), as.factor(committee$committee_chair_score_text))
table(as.factor(committee$committee_chair_score_text), as.factor(committee$faculty_activity))
table(as.factor(committee$activity_text), as.factor(committee$app_year))

examine_hold <- committee %>% filter(activity_text == "Hold" & !is.na(committee_chair_score_text)) 

#No committee data prior to 2013
```




```{r, gpa}
gpa <- raw_files %>% 
  extract_data("/GPA_Scores")


gpa_final <- gpa %>% 
  distinct(aamc_id, aca_status_desc, .keep_all = TRUE) 
#write this paper for final dataset


#Question's for model building
#What's the gpa at time of application? 
#What's the gpa at from their primary institution? 

```


```{r, ethnicity}

ethnicity <- raw_files %>% 
  extract_data("/Ethnicity")

ethnicity_final <- ethnicity %>% 
  distinct(aamc_id, ethnicity, .keep_all = TRUE) %>% 
  dplyr::select(-appl_year)
#write this for the final dataset

```


```{r, race}
race <- raw_files %>% 
  extract_data("/Race")

race_final <- race %>% 
  distinct(aamc_id, race, .keep_all = TRUE) %>% dplyr::select(-appl_year)
#write this file for final dataset

```


```{r, school}

schools <- raw_files %>% 
  extract_data("/School.csv")

names(schools)


#create a distinct dataset that's the unique combincation of id, name of school, and type of schools
schools_final <- schools %>% 
  distinct(aamc_id, mod_school_desc, program_type_desc, .keep_all = TRUE)
#write this datatset for final dataset


#What is the student's primary undergraduate institution
#Has a master's degree? 
```



```{r, write_to_drive}

#old mcat
write_csv(mcat_old2, "/Volumes/admissions/final_datasets/old_mcat_scores.csv")

#new mcat
write_csv(mcat_new2, "/Volumes/admissions/final_datasets/new_mcat_scores.csv")

#ethnicity
write_csv(ethnicity_final, "/Volumes/admissions/final_datasets/ethnicity.csv")

#race
write_csv(race_final, "/Volumes/admissions/final_datasets/race.csv")

#gpa 
write_csv(gpa_final, "/Volumes/admissions/final_datasets/gpa.csv")

#schools
write_csv(schools_final, "/Volumes/admissions/final_datasets/schools.csv")

#mmi
write_csv(mmi_pull_2, "/Volumes/admissions/final_datasets/mmi_scores.csv")
```

