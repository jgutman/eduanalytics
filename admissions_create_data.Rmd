title: "Admissions dataset generation"
author: "Jacqueline Gutman, Suvam Paul"
date: 'Last updated: `r format(Sys.Date(), "%B %d, %Y") ` '
output:
  html_document:
    toc: yes
    toc_depth: '4'
  html_notebook:
    highlight: tango
    theme: cosmo
    toc: yes
    toc_depth: 4
---

```{r, message = FALSE}
library(tidyverse)
library(magrittr)
library(knitr)

opts_chunk$set(message = FALSE, warning = FALSE, comment = "   ",
               cache = TRUE, autodep = TRUE, cache.comments = FALSE)

#list.dirs("/Volumes/", full.names = TRUE, recursive = FALSE)
admissions_path <- "/Volumes/admissions"
(raw_files <- list.files(admissions_path, full.names = TRUE))
```


```{r, message = FALSE}
extract_data <- function(file_list, pattern) {
  file_list %>%
    stringr::str_detect(regex(pattern, ignore_case = TRUE)) %>%
    which() %>%
    extract2(file_list, .) %>%
    read_csv() %>%
    set_colnames(tolower(colnames(.)))
}

applications <- raw_files %>%
  extract_data("/application") %>%
  select(-first_name, -last_name)

app_repeated_count <- applications %>% 
  group_by(aamc_id) %>% 
  summarise(count_num = n()) %>% 
  filter(count_num > 1) %>% 
  arrange(aamc_id) %>% 
  ungroup()

applications_rep_info <- left_join(applications, app_repeated_count, by = "aamc_id")
applications_rep_info <- applications_rep_info %>% arrange(aamc_id, desc(appl_year))

applications_rep_info_14_17 <- applications_rep_info %>% filter(appl_year == 2014 | appl_year == 2015 | appl_year == 2016 | appl_year == 2017)


table(as.factor(applications_rep_info_14_17$application_status))


table(as.factor(applications_rep_info_14_17$appl_year))
table(as.factor(applications_rep_info_14_17$application_status))
table(as.factor(applications_rep_info_14_17$count_num))
table(is.na(applications_rep_info_14_17$count_num))

head(applications_rep_info_14_17)

#how do I handle students in multiple years? 
#combine year and aamc_id
applications_rep_info_14_17_non_null_numcount <- applications_rep_info_14_17 %>% 
  filter(count_num == 2 | count_num == 3) %>% arrange(aamc_id)


#someone could have applied multiple years,and get rejected. How about someone who got rejected, and then accepted
applications_rep_info_14_17_non_null_numcount_accepted <- applications_rep_info_14_17_non_null_numcount %>% filter(application_status == "Accepted")



examine_repeates <- applications_rep_info_14_17_non_null_numcount %>% filter(aamc_id == 13791324)



```

```{r}
applications %>%
  filter(program_name == "Regular M.D.") %>%
  group_by(appl_year, application_status) %>%
  summarize(count = n()) %>%
  spread(application_status, count, fill = 0)
```

```{r}
applications %>% 
  group_by(aamc_id) %>%
  summarize(n_times_applied = n_distinct(appl_year)) %>%
  group_by(n_times_applied) %>%
  summarize(n_applicants = n())
```


```{r, message = FALSE}
mcat_old <- raw_files %>% 
  extract_data("/mcat") %>%
  set_colnames(stringr::str_replace(colnames(.), "_p$", "_percentile"))

mcat_new <- raw_files %>% 
  extract_data("new_mcat")
```

```{r, message = FALSE}

mmi_full <- raw_files %>% 
  extract_data("/mmi.csv")

```

```{r, message = FALSE}
# get percent missing by column by year
mmi_full %>%
  group_by(app_year) %>%
  summarize_all(funs(mean(is.na(.))))


# all rows and applicants included
mmi_full %>%
  group_by(app_year) %>%
  summarize(n = n(),
            n_applicants = n_distinct(appl_person_id))

# non-null rows and applicants only
mmi_full %>% 
  group_by(app_year) %>% 
  filter(!is.na(rank) | !is.na(interviewer_type)) %>%
  summarize(n = n(), n_applicants = n_distinct(appl_person_id))


#mmi dataset that's non-null and applicants only
mmi_nonnull_applicants <- mmi_full %>% 
    filter(!is.na(rank) | !is.na(interviewer_type)) %>% 
  arrange(aamc_id)


mmi_nonnull_examine <- mmi_full %>% filter(aamc_id == 13791324)
mmi_nonnull_examine

```


```{r, message=FALSE}

#new mmi pull
mmi_pull_2 <- raw_files %>% 
  extract_data("/MMI_Scores_Admission")


mmi_nonnull_examine_2 <- mmi_pull_2 %>% filter(amcas_id == 13791324)


```

