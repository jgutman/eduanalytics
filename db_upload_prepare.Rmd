---
title: "Prepare identified and deidentified datasets for database"
author: "Jacqueline Gutman, Suvam Paul"
date: 'Last updated: `r format(Sys.Date(), "%B %d, %Y") ` '
output:
  html_document:
    toc: yes
    toc_depth: '4'
  html_notebook:
    highlight: tango
    theme: cosmo
    toc: yes
    toc_depth: 4
---

# Setup 

```{r setup, message = FALSE}
library(tidyverse)
library(RMySQL)
library(yaml)
library(knitr)
library(stringr)
library(magrittr)
library(lubridate)

sessionInfo()$otherPkgs %>%
  map_chr(function(pkg) paste(pkg$Package, pkg$Version)) %>%
  cat(sep = "\n")
opts_chunk$set(message = FALSE, warning = FALSE, comment = "   ",
            cache = TRUE, autodep = TRUE, cache.comments = FALSE)

```

# Create database connection

```{r, echo=FALSE}
credentials_path <- "/Volumes/IIME/EDS/data/admissions/db_credentials/"
credentials_file <- "owner_credentials.yaml"
credentials <- paste0(credentials_path, credentials_file) %>%
  yaml::yaml.load_file()

edu_db_con <- dbConnect(MySQL(),
        user = credentials$user,
        password = credentials$password,
        dbname = credentials$dbname,
        host = credentials$host,
        port = credentials$port)

# edu_db <- src_mysql(credentials$dbname,
#                     host = credentials$host,
#                     port = credentials$port,
#                     user = credentials$user,
#                     password = credentials$password)

rm(credentials)
```

# Check available data directories

```{r}
parent_path <- "/Volumes/IIME/EDS/data/admissions"
(data_dirs <- list.dirs(parent_path, full.names = TRUE, recursive = FALSE))
```

# Upload identified datasets
- No study_id column
- Fully identified versions

## Upload raw datasets

### Upload admissions-provided datasets

- 2013_all_applicants
- 2013_matriculated_report
- 2013_tracking_report
- 2014_all_applicants
- 2014_matriculated_report
- 2014_tracking_report
- 2015_all_applicants
- 2015_matriculated_report
- 2015_tracking_report
- 2016_all_applicants
- 2016_matriculated_report
- 2016_tracking_report

```{r}
identified_raw_admissions_path <- paste(data_dirs[[1]], "Data", sep = "/")
(identified_raw_admissions_files <- list.files(identified_raw_admissions_path, full.names = TRUE))
```

```{r}
fix_colnames <- . %>% 
  map(function(df) set_names(df, str_replace_all(colnames(df), " ", "_"))) %>%
  map(function(df) set_names(df, tolower(colnames(df))))

identified_raw_admissions_files %>% 
  map(function(path) readxl::read_excel(path)) %>%
  fix_colnames() ->
  identified_raw_admissions_list
```

```{r}
(table_names <- paste(rep(2013:2016, each = 3), 
                      c("all_applicants", "matriculated_report", "tracking_report"), sep = "_") %>%
  paste("identified", "raw", ., sep = "$"))

identified_raw_admissions_list %<>% 
  set_names(table_names) %>%
  map(function(df) set_names(df, str_replace(colnames(df), "recevied", "received")))

```

```{r}
write_to_database <- function(df_list, con) {
  df_list %>%
    map2(., names(.), function(df, tbl_name) 
      dbWriteTable(edu_db_con, tbl_name, df, row.names = FALSE, overwrite = TRUE))
}

identified_raw_admissions_list %>% write_to_database(edu_db_con)
  
```

### Upload EduDW-provided datasets

- ethnicity [`Ethnicity.csv`]
- gpa [`GPA_Scores.csv`]
- old_mcat [`mcat.csv`]
- mmi_scores [`MMI_Scores_Admission.csv`]
- new_mcat [`NEW_MCAT.csv`]
- race [`Race.csv`]
- school [`School.csv`]

```{r}
identified_raw_edudw_path <- data_dirs[[8]]
(identified_raw_edudw_files <- list.files(identified_raw_edudw_path, full.names = TRUE))
```

```{r}
identified_raw_edudw_files %>% 
  map(function(path) read_csv(path)) %>%
  fix_colnames() ->
  identified_raw_edudw_list
```

```{r}
(table_names <- identified_raw_edudw_files %>% 
  str_replace(identified_raw_edudw_path, "") %>% 
  str_replace_all(c("/" = "", ".csv" = "")) %>%
  paste("identified", "raw", ., sep = "$"))

identified_raw_edudw_list %<>% 
  set_names(table_names)
```

#### Determine date-formatted columns in each table

```{r}
time_formats <- c("%Y-%m-%d %H:%M:%S", "%d-%b-%y")

identified_raw_edudw_list$`identified$raw$mmi_scores` %<>%
  mutate(start_time = parse_date_time(start_time, time_formats))

identified_raw_edudw_list$`identified$raw$new_mcat` %<>%
  mutate(new_mcat_test_date = parse_date_time(new_mcat_test_date, time_formats),
         new_mcat_percentile_effe_date = parse_date_time(new_mcat_percentile_effe_date, time_formats))

identified_raw_edudw_list$`identified$raw$old_mcat` %<>%
  mutate(test_date = parse_date_time(test_date, time_formats))

identified_raw_edudw_list$`identified$raw$school` %<>%
  mutate(attend_start_dt = parse_date_time(attend_start_dt, time_formats),
         attend_finish_dt = parse_date_time(attend_finish_dt, time_formats))

no_date_cols <- . %>%
  map_lgl(is.POSIXt) %>%
  sum() %>%
  equals(0)

identified_raw_edudw_list %>% map_lgl(no_date_cols)
```

```{r}
identified_raw_edudw_list %>% 
  write_to_database(edu_db_con)
```

```{r}
get_time_cols <- . %>%
  select_if(is.POSIXt) %>%
  colnames()

identified_raw_admissions_list %>%
  map(get_time_cols) -> tbl_list

tbl_list %>%
  data_frame(date_time_cols = .) %>%
  mutate(tbl_name = names(tbl_list)) %>%
  filter(map_lgl(date_time_cols, function(a) length(a) > 0)) %>% 
  unnest() -> date_time_columns

identified_raw_edudw_list %>%
  map(get_time_cols) -> tbl_list

tbl_list %>%
  data_frame(date_time_cols = .) %>%
  mutate(tbl_name = names(tbl_list)) %>%
  filter(map_lgl(date_time_cols, function(a) length(a) > 0)) %>% 
  unnest() %>%
  bind_rows(date_time_columns) -> date_time_columns

date_time_columns %>%
  write_csv("date_time_cols_to_convert.csv")
```

```{r}
map(dbListConnections(MySQL()), dbDisconnect)
```

## Convert dates to POSIXct/dttm
```{r}
quietly_parse_time <- quietly(function(.x) 
  parse_date_time(.x, "YmdHMS", 
      tz = "America/New_York", truncated = 3))

convert_or_retain <- function(col) {
  col_mutated <- quietly_parse_time(col)
  
  no_errors <- is_empty(col_mutated$warnings)
  
  if (no_errors) col_mutated$result else col
}
```


## Testing reading in a table to memory

```{r}
edu_db <- src_sql("mysql", edu_db_con, info = dbGetInfo(edu_db_con))

tbl(edu_db, "identified$raw$2013_all_applicants") %>%
  collect() %>%
  mutate_if(is.character, convert_or_retain) ->
  all_apps_2013

```



