---
title: "Prepare identified and deidentified datasets for database"
author: "Jacqueline Gutman, Suvam Paul"
date: 'Last updated: `r format(Sys.Date(), "%B %d, %Y") ` '
output:
  html_document:
    toc: yes
    toc_depth: '4'
  html_notebook:
    highlight: tango
    theme: cosmo
    toc: yes
    toc_depth: 4
---

# Setup 

```{r setup, message = FALSE}
library(tidyverse)
library(RMySQL)
library(yaml)
library(knitr)
library(stringr)
library(magrittr)
library(lubridate)

sessionInfo() %>%
use_series(otherPkgs) %>%
  map_chr(function(pkg) paste(pkg$Package, pkg$Version)) %>%
  cat(sep = "\n")

opts_chunk$set(message = FALSE, warning = FALSE, comment = "   ",
            cache = TRUE, autodep = TRUE, cache.comments = FALSE)

```

```{r}
# Replace with import package
source("db_utility_functions.R")
```

# Create database connection

```{r, echo=FALSE}
credentials_path <- "/Volumes/IIME/EDS/data/admissions/db_credentials/"
credentials_file <- "owner_credentials.yaml"

edu_db_con <- get_mysql_conn(credentials_path, credentials_file)
```

# Check available data directories

```{r}
parent_path <- "/Volumes/IIME/EDS/data/admissions"
(data_dirs <- list.dirs(parent_path, full.names = TRUE, recursive = FALSE))
```

# Upload identified datasets
- No study_id column
- Fully identified versions

## Upload raw datasets

### Upload admissions-provided datasets

- 2013_all_applicants
- 2013_matriculated_report
- 2013_tracking_report
- 2014_all_applicants
- 2014_matriculated_report
- 2014_tracking_report
- 2015_all_applicants
- 2015_matriculated_report
- 2015_tracking_report
- 2016_all_applicants
- 2016_matriculated_report
- 2016_tracking_report

```{r}
data_dirs %>% 
  str_detect("from_.*admissions") %>% 
  extract(data_dirs, .) %>%
  file.path(., "Data") ->
  identified_raw_admissions_path

list.files(identified_raw_admissions_path, full.names = TRUE) %>%
  print() -> identified_raw_admissions_files
```

```{r}
identified_raw_admissions_files %>% 
  map(function(path) readxl::read_excel(path)) %>%
  fix_colnames() ->
  identified_raw_admissions_list
```

```{r}
paste(rep(2013:2016, each = 3), 
        c("all_applicants", "matriculated_report", "tracking_report"), sep = "_") %>%
  add_tbl_prefix(id = "identified", status = "raw") %>%
  print() -> table_names

identified_raw_admissions_list %<>% 
  set_names(table_names) %>%
  map(function(df) set_names(df, str_replace(colnames(df), "recevied", "received")))

```

```{r}
identified_raw_admissions_list %>% 
  write_to_database(edu_db_con)
```


### Upload EduDW-provided datasets

- ethnicity
- gpa
- old_mcat
- mmi_scores
- new_mcat
- race
- school
- experiences



```{r}
identified_raw_edudw_path <- data_dirs %>% 
  str_detect("raw.*identified.*edudw") %>% 
  extract(data_dirs, .)

list.files(identified_raw_edudw_path, full.names = TRUE) %>%
  print() -> identified_raw_edudw_files

identified_raw_edudw_files %<>% 
  str_detect("experience") %>% 
  not() %>% 
  extract(identified_raw_edudw_files, .)
```

```{r}
experiences_path <- file.path(identified_raw_edudw_path, 
                              "experiences.csv")
```

```{r}
exp <- read_csv(experiences_path)
exp_old <- filter(exp, appl_year < 2013)
exp_current <- filter(exp, appl_year >= 2013)
rm(exp)
```

```{r}
exp_old %<>%
  mutate_if(is.character, function(col) if_else(col == "null", NA_character_, col))

exp_current %<>%
  mutate_if(is.character, function(col) if_else(col == "null", NA_character_, col))
```



```{r}
identified_raw_edudw_files %>% 
  map(function(path) read_csv(path)) %>%
  fix_colnames() ->
  identified_raw_edudw_list
```

```{r}
identified_raw_edudw_files %>% 
  str_replace(identified_raw_edudw_path, "") %>% 
  str_replace_all(c("/" = "", ".csv" = "")) %>%
  add_tbl_prefix(id = "identified", status = "raw") %>%
  print() -> table_names

identified_raw_edudw_list %<>% 
  set_names(table_names) %>%
  map(function(df) set_names(df, 
        str_replace(colnames(df), "(?<=(low)|(high))_p$", "_percentile")))
```

#### Determine date-formatted columns in each table

```{r}
time_formats <- c("%Y-%m-%d %H:%M:%S", "%d-%b-%y")
parse_time_mod <- purrr::partial(lubridate::parse_date_time, 
                      tz = "America/New_York", truncated = 3)

identified_raw_edudw_list$`identified$raw$mmi_scores` %<>%
  mutate(start_time = parse_time_mod(start_time, time_formats))

identified_raw_edudw_list$`identified$raw$new_mcat` %<>%
  mutate(new_mcat_test_date = parse_time_mod(new_mcat_test_date, time_formats),
         new_mcat_percentile_effe_date = parse_time_mod(new_mcat_percentile_effe_date, time_formats))

identified_raw_edudw_list$`identified$raw$old_mcat` %<>%
  mutate(test_date = parse_time_mod(test_date, time_formats))

identified_raw_edudw_list$`identified$raw$school` %<>%
  mutate(attend_start_dt = parse_time_mod(attend_start_dt, time_formats),
         attend_finish_dt = parse_time_mod(attend_finish_dt, time_formats))

no_date_cols <- . %>%
  map_lgl(is.POSIXt) %>%
  sum() %>%
  equals(0)

identified_raw_edudw_list %>% 
  map_lgl(no_date_cols)
```

```{r}
identified_raw_edudw_list %>% 
  write_to_database(edu_db_con)
```

```{r}
disconnect_all()
```




