---
title: "Construct design matrix"
author: "Jacqueline Gutman, Suvam Paul"
date: 'Last updated: `r format(Sys.Date(), "%B %d, %Y") ` '
output:
  html_document:
    toc: yes
    toc_depth: '4'
  html_notebook:
    highlight: tango
    theme: cosmo
    toc: yes
    toc_depth: 4
---

# Setup
## Load packages
## Read in database credentials and open connection

```{r setup, message=FALSE, echo = FALSE}
knitr::read_chunk("setup_notebook.R")
```

```{r setup_notebook}
```

```{r show_pkgs, echo = FALSE}
print_loaded_pkgs()
```

# Extract generated features from database

```{r}
generated_features <- get_tbl_names_by_stage(edu_db_con, "deidentified", "generated")
```

```{r}
# "all_applicants" %>% 
#   add_tbl_prefix() %>%
#   put_tbl_to_memory(edu_db_con, .) %>%
#   filter(is_faculty_screened == 1) ->
#   screened_applicants
```

```{r}
# outcomes <- screened_applicants %>%
#   select(study_id, is_invited_interview)

```


```{r}
outcomes <- "aoa"

outcome_data <- add_tbl_prefix(outcomes, status = "outcome") %>% 
  put_tbl_to_memory(edu_db_con, .)
```

```{r}
fetch_and_join <- function(df, tbl_name, conn, key) {
  tbl_name %>%
    put_tbl_to_memory(conn, .) %>%
    select(-one_of("appl_year")) %>%
    left_join(df, ., by = key)
}

reduce(generated_features, fetch_and_join, 
       conn = edu_db_con, key = "study_id", 
       .init = outcome_data) -> 
  features_plus_outcome
```

```{r}
# model_run_name <- "grades_gpa_mcat_other_features"
model_run_name <- "grades_gpa_mcat_medschool"

features_plus_outcome %>%
  write_to_database_single(edu_db_con, add_tbl_prefix(model_run_name, status = "model_data"))
```

```{r}
disconnect_all()
```

