---
title: "Prepare clean tables with basic cleaning and filtering"
subtitle: "Clean schema in preparation for ready-for-analysis stage"
author: "Jacqueline Gutman, Suvam Paul"
date: 'Last updated: `r format(Sys.Date(), "%B %d, %Y") ` '
output:
  html_document:
    toc: yes
    toc_depth: '4'
  html_notebook:
    highlight: tango
    theme: cosmo
    toc: yes
    toc_depth: 4
---

# Setup
## Load packages
## Read in database credentials and open connection

```{r setup, message=FALSE, echo = FALSE, purl = FALSE}
knitr::read_chunk("setup_notebook.R")
```

```{r setup_notebook, purl = FALSE}
```

```{r echo = FALSE, purl = FALSE}
print_loaded_pkgs()
```

## Optionally write all deidentified data to text files

```{r}
write_deidentified_to_file = FALSE
deidentified_output <- "/Volumes/IIME/EDS/data/admissions/data_for_itai/"
```

```{r}
query_rename_col <- "alter table ${tbl_name} change ${old_name} ${new_name} DOUBLE;"
tbl_names <- get_tbl_names_by_stage(edu_db_con, "deidentified", "raw")

tbl_names %>%
  find_tbls_with_col("app_year", edu_db_con) %>%
  map(function(tbl_name) interpolate_and_execute(query_rename_col, edu_db_con,
          commit = TRUE, tbl_name = tbl_name,                               
           old_name = "app_year", new_name = "appl_year"))
```

```{r}
pattern <- "^deidentified\\Wraw\\W[[:alpha:]].*[[:alpha:]]$"

db_list_tables(edu_db_con) %<>%
  str_detect(pattern) %>%
  extract(tbl_names, .) %>%
  print() -> tbl_names

edu_db_con %>%
  get_tbls_by_pattern(pattern, in_memory = FALSE) %>%
  set_names(tbl_names) -> edudw_deidentified
```

```{r}
min_year <- 2014
max_year <- 2017

edudw_deidentified %<>%
  map(function(df) filter(df,
        appl_year >= min_year, appl_year <= max_year)) %>%
  map(collect, n = Inf) %>%
  map(function(df) group_by(df, study_id)) %>%
  map(function(df) filter(df, appl_year == min(appl_year)))
```

```{r}
edudw_deidentified$`deidentified$raw$mmi_scores` %<>%
  select(-mmi_question_id, -code) %>%
  mutate(interviewer_type = str_replace(interviewer_type, "Interviewer ", "")) %>%
  mutate(interviewer_type = as.integer(interviewer_type))
```

```{r}
edudw_deidentified$`deidentified$raw$experiences` %<>%
  replace_na(list(first_total_hrs = 0,
                  second_total_hrs = 0,
                  third_total_hrs = 0,
                  fourth_total_hrs = 0)) %>%
  mutate(total_hrs = first_total_hrs + second_total_hrs +
                     third_total_hrs + fourth_total_hrs)
```

```{r}
names(edudw_deidentified) %>%
  get_tbl_suffix() %>%
  add_tbl_prefix(status = "clean") ->
  tbl_names

edudw_deidentified %<>%
  map(drop_empty_cols) %>%
  set_names(tbl_names)
```

```{r}
edudw_deidentified %>%
  write_to_database(edu_db_con)
```

```{r}
if (write_deidentified_to_file) {
  names(edudw_deidentified) %>%
    get_tbl_suffix() %>%
    paste("clean", "deidentified.csv", sep = "_") ->
    filenames

  edudw_deidentified %>%
    map2(filenames, function(df, name) write_to_file(df, deidentified_output, name))
}
```

## Add clean for admissions pile of data

```{r}
pattern <- "^deidentified\\Wraw\\W\\d{4}.*[[:alpha:]]$"

```

```{r}
tracking_columns <- c("appl_submit_date",
                      "appl_complete_date",
                      "screening_complete_date",
                      "interview_invite_date",
                      "interview_schedule_date",
                      "interview_day",
                      "interview_complete_date",
                      "committee_date",
                      "offer_date",
                      "accept_date")
```


```{r}
disconnect_all()
```
