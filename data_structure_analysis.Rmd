---
title: "Untitled"
author: "Dana Weisenfeld"
date: "April 26, 2017"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, fig.align = 'center')

library(RMySQL)
library(yaml)
library(data.table)
library(knitr)
library(tidyverse)
library(stringr)
library(magrittr)
library(lubridate)
library(dbUtilities)
library(DBI)
library(VIM)
library(rlang)
```


```{r credentials}

#credentials_path <- "/Users/iime/Desktop/DW"
credentials_path <- "/Volumes/IIME/EDS/data/admissions/db_credentials"
edu_deid_con <- dbUtilities::get_mysql_conn(path = credentials_path, credentials_file = "edu_deid.my.cnf", group = "edu_deident")

tables_list <- dbListTables(edu_deid_con)

clean_tables <-  tables_list[grep("clean", tables_list)]

# gpa
dat <- dbUtilities::put_tbl_to_memory(edu_deid_con, clean_tables[4])

#list tof tiblles
tbl <- dbUtilities::get_tbls_by_pattern(edu_deid_con, "\\Wclean\\Wgpa|\\Wclean\\Wexperiences")


```


```{r miss_plot}

# percent missing in each numeric var
pct_miss <- dat %>%
  dplyr::group_by(appl_year) %>%
  summarize_all(funs(pct_missing = mean(is.na(.)))) %>%
  column_to_rownames("appl_year") %>%
  t() %>%
  multiply_by(100) %>%
  round(., 2)


# visually display missings
aggr(dat, bars=FALSE, numbers=FALSE, sortVars=TRUE)


######## refactor of code to explore a single tibble and a list of tibbles#######

# a single tibble
explore_missingness_single <- function(dat, plot = TRUE) {
  
  miss_obj <- aggr(dat, bars = FALSE, sortVars = TRUE, numbers = TRUE, plot = plot)
  summary(miss_obj)
  
}

#a list of tibbles
explore_missingness <- function(df_list, plot = TRUE) {
  
  df_list %>% 
    map(., function(df)
      explore_missingness_single(df, plot = plot))
}


explore_missingness(tbl, plot = TRUE)
explore_missingness_single(dat, plot = FALSE)

###################################################################################



# complete cases
complete.obs <- sum(complete.cases(dat)) / nrow(dat)






```


`r complete.obs`% of observations in data are complete. 


```{r}

# converting application year to character
dat$appl_year <- as.character(dat$appl_year)

# converting study_id to factor so it is ignored
dat$study_id <- as.factor(dat$study_id)

# summarize variables

classes <- dat %>% map(class) %>% sapply(function(x) x[1])
names(classes) <- NULL

nums <- which(classes=="numeric")
binaries <- nums[apply(dat[nums],2,function(x) { all(na.omit(x) %in% 0:1) })]
continuous <- setdiff(nums, binaries)
  
cats <- which(classes=="character")
dates <- which(classes=="POSIXct")

```

__Summary Statistics__

There are `r length(continuous)` continuous numeric variables in the dataset.

```{r summarize_continuous_vars}

if (length(continuous)>0) {
  
dat <- as.data.frame(dat)

sumstats <- matrix(NA, nrow=length(continuous)*4, 9, dimnames=list(c(), 
                  c("Year", "N", "Min", "Q1", "Median", "Mean", "Q3", "Max", "SD")))
j = 1
for (i in 1:length(continuous)) {
  for (y in unique(dat$appl_year)) {
    sumstats[j,1] <- y
    sumstats[j,2] <- sum(!is.na(dat[dat$appl_year==y,continuous[i]]))
    sumstats[j,3] <- min(dat[dat$appl_year==y,continuous[i]], na.rm=TRUE)
    sumstats[j,4] <- quantile(dat[dat$appl_year==y,continuous[i]], .25, na.rm=TRUE)
    sumstats[j,5] <- median(dat[dat$appl_year==y,continuous[i]], na.rm=TRUE)
    sumstats[j,6] <- round(mean(dat[dat$appl_year==y,continuous[i]], na.rm=TRUE),2)
    sumstats[j,7] <- quantile(dat[dat$appl_year==y,continuous[i]], .75, na.rm=TRUE)
    sumstats[j,8] <- max(dat[dat$appl_year==y,continuous[i]], na.rm=TRUE)
    sumstats[j,9] <- round(sd(dat[dat$appl_year==y,continuous[i]], na.rm=TRUE),2)
    j = j + 1
  }
}

# row names
new_seq <- seq(1, to = nrow(sumstats), by = 4)

row_names <- rep("", nrow(sumstats))

for(i in 1:length(continuous)) {
  row_names[new_seq[i]] <- names(dat)[continuous[i]]
}

row.names(sumstats) <- row_names

kable(sumstats)
}




##########################refeactor summary for numerical variables##############


get_basic_summaries_single <- function(dat, varname) {
  
  quo_group_by <- enquo(varname)
  print(quo_group_by)
  
  dat %>% 
    group_by(!!quo_group_by) %>% 
    summarise_if(., is.numeric, funs(min, max, mean, median), na.rm = TRUE)
}


get_basic_summaries_single(dat, appl_year)



get_basic_summaries <- function(df_list, varname) {
  
  quo_group_by <- enquo(varname)
  print(quo_group_by)
  

  df_list %>% 
    map(., function(df) {
      df %>% 
        group_by(!!quo_group_by) %>% 
          summarise_if(., is.numeric, funs(min,max, mean, median), na.rm = TRUE)
    }
  )
}

get_basic_summaries(df_list = tbl, varname = appl_year)



################################################################################


#quantiles diffiucly
dat %>% 
  group_by(appl_year) %>% 
  summarise_if(., is.numeric, quantile, na.rm = TRUE, prob = 0.25) 






```

There are `r binaries` binary variables in the dataset. 
 
```{r binaries}

if (length(binaries) > 0) {
  
binary_mat <- matrix(NA, nrow=length(binaries), 2, dimnames=list(c(), 
                  c("N", "Proportion"))) 
  
binary_mat[i,1] <- sum(!is.na(dat[,binaries[i]]))
binary_mat[i,2] <- mean(dat[,binaries[i]], na.rm=TRUE)

row.names(binary_mat) <- names(dat)[binaries]

kable(binary_mat)

}


```


__Correlation Matrix__

```{r corr_matrix}

cor_mat <- round(cor(dat[nums], use = 'pairwise.complete.obs'),2)

kable(cor_mat)

```

```{r histograms}

# l <- length(nums)
# 
# if (l <= 5) { par(mfrow=c(1,l)) }
# if (l >5 & l <= 10) {
#   if (l %% 2 == 0) { par(mfrow=c(2, l/2)) }
#   else { par(mfrow=c(2,5)) }
# }
# if (l > 10) {
#   par(mfrow=c(l %/% 5 + 1, 5))
# }

for (i in nums) {
  var <- names(dat)[i]  
  hist(dat[,i], main = var, xlab="", ylab="")
}

```


```{r categorical_tables, results='asis'}

# Want N's and proportions in each category
for (i in 1:length(cats)) {
  rawN <- sort(as.numeric(table(dat[,cats[i]])), decreasing=TRUE)
  prop <- sort(round(as.numeric(prop.table(table(dat[,cats[i]]))),2), decreasing=TRUE)

  col_names <- names(table(dat[,cats[i]]))
  
  if (length(rawN) > 10) {
    rawN <- rawN[1:10]
    prop <- prop[1:10]
    col_names <- names(table(dat[,cats[i]]))[1:10]
    }
  
  cells <- paste0(rawN, " (", prop, ")")
  names(cells) <- col_names
  #cells <- as.matrix(cells, ncol=4, dimnames = list(c(), col_names))

  print(kable(t(cells)), caption = names(dat[cats[i]]))
}

```


```{r dates}

