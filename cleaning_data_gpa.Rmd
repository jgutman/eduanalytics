---
title: "Create clean version of GPA dataset"
author: "Suvam Paul"
date: 'Last updated: `r format(Sys.Date(), "%B %d, %Y") ` '
output:
  html_document:
    toc: yes
    toc_depth: '4'
  html_notebook:
    highlight: tango
    theme: cosmo
    toc: yes
    toc_depth: 4
---


```{r setup, message=FALSE, echo = FALSE, purl = FALSE}
knitr::read_chunk("setup_notebook.R")
```

```{r setup_notebook, purl = FALSE}

```



```{r check_tables_in_database}

table_names <- dbListTables(edu_db_con) %>% print()

```


```{r get_gpa_dataset}

#get data
gpa <- dbUtilities::put_tbl_to_memory(edu_db_con, "deidentified$clean$gpa")

```


```{r ensure_has_14_17_data}

#assert that application years are between 2014 and 2017
#assertive::assert_all_are_in_closed_range(gpa$appl_year, lower = 2014, upper = 2017, na_ignore = TRUE, severity = "warning")

```



```{r drop_high_school}
#education levels
table(gpa$aca_status_desc)

#drop high school grades
gpa %>% filter(aca_status_desc != "High School") -> gpa
```





```{r simple_functions}
#simple utility funcions - missingness

#functions
is_science_gpa_missing <- . %>% 
  use_series(bcpm_gpa) %>% 
  is.na() %>% 
  sum()


missing_science_gpa_year <- . %>% 
  group_by(appl_year) %>% 
  summarise(count = sum(is.na(bcpm_gpa)))

```



```{r missing}
#total missing
gpa %>% is_science_gpa_missing()
#7187


#missing breakdown by application year
gpa %>% missing_science_gpa_year()
```



```{r postbacs}

#1. any postback missing science gpa
gpa %>% filter(is.na(bcpm_gpa) & aca_status_desc == "Postbaccalaureate Undergraduate") 


#if postback then science gpa is also total gpa
gpa %>% 
  mutate(bcpm_gpa = ifelse((is.na(bcpm_gpa) & aca_status_desc == "Postbaccalaureate Undergraduate"), total_gpa, bcpm_gpa)) -> gpa
  

gpa %>% is_science_gpa_missing()
#6911



#2. Are there people still missing science gpa if postbac - total or science - yes!
gpa %>%  
  filter(aca_status_desc == "Postbaccalaureate Undergraduate") %>% 
  filter(is.na(bcpm_gpa) | is.na(total_gpa)) %>%
  dim()


gpa %>% sho




gpa %>% is_science_gpa_missing()
#5496

```




```{r}

#3.
#did postback and has at least one science gpa?

gpa %>% 
  filter(is.na(bcpm_gpa) & aca_status_desc == "Postbaccalaureate Undergraduate" | aca_status_desc == "Junior") %>% 
  group_by(study_id) %>% 
  summarise(is.na())



#missing status
gpa %>% is_science_gpa_missing()  
#6700

gpa %>% missing_science_gpa_year()


#explore missing
missing_science_gpa <- gpa %>% group_by(study_id) %>% summarise(missing = sum(is.na(bcpm_gpa))) %>% filter(missing > 0)
gpa %>% filter(study_id == "002b99176d360c9275696b20a193b186")


```

