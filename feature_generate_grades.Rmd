---
title: "Generate grades-based features"
author: "Jacqueline Gutman, Suvam Paul"
date: 'Last updated: `r format(Sys.Date(), "%B %d, %Y") ` '
output:
  html_document:
    toc: yes
    toc_depth: '4'
  html_notebook:
    highlight: tango
    theme: cosmo
    toc: yes
    toc_depth: 4
---

# Setup
## Load packages
## Read in database credentials and open connection

```{r setup, message=FALSE, echo = FALSE}
knitr::read_chunk("setup_notebook.R")
```

```{r setup_notebook}
```

```{r show_pkgs, echo = FALSE}
print_loaded_pkgs()
```

# Generate grades features from deidentified clean

```{r}
"grades" %>%
  add_tbl_prefix() %>%
  put_tbl_to_memory(edu_db_con, .) -> grades_input
```

```{r}
count_grades <- function(df) {
  df %>%
    group_by(study_id) %>%
    summarize(a_counts = sum(amcas_grade_cd %in% c("A", "A-"), na.rm = TRUE),
            b_counts = sum(amcas_grade_cd %in% c("B", "B+", "B-", "AB"), na.rm = TRUE),
            c_counts = sum(amcas_grade_cd %in% c("C", "C+", "C-", "BC"), na.rm = TRUE),
            d_counts = sum(amcas_grade_cd %in% c("D", "D+", "D-", "CD", "DE"), na.rm = TRUE),
            f_counts = sum(amcas_grade_cd == "F", na.rm = TRUE))
}

bcpm_grade_counts <- grades_input %>%
  filter(bcpm_ind == 1) %>%
  count_grades() %>%
  rename_if(is.integer, funs(paste0("bcpm_", .)))
```

```{r}
grades_input %>%
  filter(bcpm_ind == 1) %>%
  mutate(class_cd = as.factor(class_cd)) %>%
  group_by(class_cd) %>%
  nest() -> nested_science

nested_science %<>%
  mutate(features = map(data, count_grades)) %>%
  mutate(features = map2(features, class_cd, 
          function(df, name) rename_if(df, is.integer, funs(paste(name, ., sep = "_"))))) 
```

```{r}
nested_science %>% 
  use_series(features) %>%
  Reduce(left_join, ., init = bcpm_grade_counts)
```

