---
title: "Education Analytics Admissions Screening Project"
author: "Jacqueline Gutman, Suvam Paul"
date: 'Last updated: `r format(Sys.Date(), "%B %d, %Y") ` '
output:
  html_document:
    toc: yes
    toc_depth: '4'
  html_notebook:
    highlight: tango
    theme: cosmo
    toc: yes
    toc_depth: 4
subtitle: Connection to edu_analytics database
---

# Setup

## Load packages

```{r, message=FALSE}
library(tidyverse)
library(knitr)
library(RMySQL)
library(yaml)
library(tidyverse)
library(magrittr)
library(knitr)
library(stringr)
library(purrr)

sessionInfo()$otherPkgs %>%
  map_chr(function(pkg) paste(pkg$Package, pkg$Version)) %>%
  cat(sep = "\n")
opts_chunk$set(message = FALSE, warning = FALSE, comment = "   ",
            cache = TRUE, autodep = TRUE, cache.comments = FALSE)

```

## Read in database credentials and open connection

```{r}
source("db_utility_functions.R")
```


```{r, echo=FALSE}
credentials_path <- "/Volumes/IIME/EDS/data/admissions/db_credentials/"
#credentials_path <- "/Volumes/IIME/IIME/EDS/data/admissions/db_credentials/"
credentials_file <- "owner_credentials.yaml"

edu_db_con <- get_mysql_conn(credentials_path, credentials_file)
```

# Admissions applicants datasets: 2013-2016

## Read in all_applicants tables from database

```{r}
(table_names <- db_list_tables(edu_db_con))

edu_db_con %>%
  get_tbls_by_pattern("^hashed\\Wraw\\W\\d{4}_all_applicants") %>%
  set_names(2013:2016) -> applicants_data
```

```{r}
# filter out irrelevant and identifying columns
applicants_data %<>% 
  drop_cols_from_list("cols_to_keep_admissions.yaml")
```

```{r}
# check that all columns and coltypes are the same for all application years
applicants_data %>% 
  at_depth(2, typeof) -> coltypes

coltypes %>% 
  as_data_frame() %>% 
  mutate_all(flatten_chr) -> coltypes_df

coltypes %>% 
  map(names) %>% 
  as_data_frame() %>% 
  all_equal_across_row()

coltypes %>% 
  extract2(1) %>% 
  names() %>%
  mutate(coltypes_df, colname = .) %>%
  select(-colname) %>% 
  all_equal_across_row()
```

```{r}
applicants_all_years <- bind_rows(applicants_data)
colnames(applicants_all_years)
```

```{r, eval = FALSE}
# write deidentified data to file
deidentified_output <- "/Volumes/IIME/EDS/data/admissions/data_for_itai/"
write_to_file <- function(df, path, filename) {
  full_path <- file.path(path, filename)
  write_csv(df, full_path)
}

applicants_all_years %>%
 write_to_file(deidentified_output, "admissions_all_applicants_deidentified.csv")
```

```{r}
names(applicants_data) %>%
  add_tbl_prefix("deidentified", "raw") %>%
  paste("all_applicants", sep = "_") ->
  tbl_names

applicants_data %<>% set_names(tbl_names)

applicants_data %>% write_to_database(edu_db_con)
```


# Raw features from eduDW tables

## Ethnicity

```{r, ethnicity, echo=FALSE}

ethnicity_raw_deid <- edu_db_con %>%
  get_tbls_by_pattern("^hashed\\Wraw\\Wethnicity$")
  select(-appl_person_id, -aamc_id)

ethnicity_clean_deid <- edu_db_con %>%
  get_tbls_by_pattern("^hashed\\Wclean\\Wethnicity$")
  select(-appl_person_id, -aamc_id)

# write data
ethnicity_raw_deid %>%
 write_to_file(deidentified_output, "ethnicity_raw_deidentified.csv")  
  
ethnicity_clean_deid %>%
 write_to_file(deidentified_output, "ethnicity_clean_deidentified.csv")  
```

## Race

```{r, race, echo=FALSE}

race_raw_deid <- edu_db_con %>%
  get_tbls_by_pattern("^hashed\\Wraw\\Wrace$")
  select(-appl_person_id, -aamc_id)

race_clean_deid <- edu_db_con %>%
  get_tbls_by_pattern("^hashed\\Wclean\\Wrace$")
  select(-appl_person_id, -aamc_id)

# write data
race_raw_deid %>%
 write_to_file(deidentified_output, "race_raw_deidentified.csv")  
  
race_clean_deid %>%
 write_to_file(deidentified_output, "race_clean_deidentified.csv") 
```

## School

```{r, schools, echo=FALSE}

schools_raw_deid <- edu_db_con %>%
  get_tbls_by_pattern("^hashed\\Wraw\\Wschool$")
  select(-appl_person_id, -aamc_id)

schools_clean_deid <- edu_db_con %>%
  get_tbls_by_pattern("^hashed\\Wclean\\Wschool$")
  select(-appl_person_id, -aamc_id)

# write data
schools_raw_deid %>%
 write_to_file(deidentified_output, "schools_raw_deidentified.csv")  
  
schools_clean_deid %>%
 write_to_file(deidentified_output, "schools_clean_deidentified.csv") 
```

## GPA

```{r, gpa, echo=FALSE}

gpa_raw_deid <- edu_db_con %>% 
  get_tbls_by_pattern("^hashed\\Wraw\\Wgpa$") %>% 
  select(-appl_person_id, -aamc_id)

gpa_clean_deid <- edu_db_con %>% 
   get_tbls_by_pattern("^hashed\\Wclean\\Wgpa$") %>% 
   select(-appl_person_id, -aamc_id)

# write data
gpa_raw_deid %>%
 write_to_file(deidentified_output, "gpa_raw_deidentified.csv")  
  
gpa_clean_deid %>%
 write_to_file(deidentified_output, "gpa_clean_deidentified.csv")
```

## MMI

```{r, mmi, echo = FALSE}

mmi_raw_deid <- table_names %>% 
  make_data_frame("^hashed\\Wraw\\Wmmi_scores$") %>% 
  select(-application_id, -amcas_id, -appl_person_id, -fac_last_name, -fac_first_name, 
         -comment, -avg, -stdev, -conflict, -interview_id, -scenario, -interview_type, -interview_type, 
         -faculty_id, -code, -mmi_question_id)

write_csv(mmi_raw_deid, "/Volumes/admissions/data_for_itai/mmi_raw_deidentified.csv")
```

## MCAT: OLD

```{r, mcat_old, echo=FALSE}

oldmcat_raw_deid <- table_names %>% 
  make_data_frame("^hashed\\Wraw\\Wold_mcat$") %>% 
  set_colnames(stringr::str_replace(colnames(.), "_p$", "_percentile")) %>% 
  select(-appl_person_id, -aamc_id)

# oldmcat_clean_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wclean\\Wmmi_scores$") %>% 
#   select(-appl_person_id, -aamc_id)

# write data
write_csv(oldmcat_raw_deid, "/Volumes/admissions/data_for_itai/oldmcat_raw_deidentified.csv")
# write_csv(oldmcat_clean_deid, "/Volumes/admissions/data_for_itai/oldmcat_clean_deidentified.csv")
```

## MCAT: NEW

```{r, new_mcat, echo=FALSE}

newmcat_raw_deid <- table_names %>% 
  make_data_frame("^hashed\\Wraw\\Wnew_mcat$") %>% 
  select(-appl_person_id, -aamc_id)
  
# newmcat_clean_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wclean\\Wnew_mcat$") %>% 
#   select(-appl_person_id, -aamc_id)

# write data
write_csv(newmcat_raw_deid, "/Volumes/admissions/data_for_itai/newmcat_raw_deidentified.csv")
# write_csv(newmcat_clean_deid, "/Volumes/admissions/data_for_itai/newmcat_clean_deidentified.csv")

```

## Parent/Guardian

```{r, parent_guardian, echo=FALSE}

parents_raw_deid <- table_names %>% 
  make_data_frame("^hashed\\Wraw\\Wparent_guardian$") %>% 
  select(-appl_person_id, -appl_year, -aamc_id, -name)

# parents_clean_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wclean\\Wparent_guardian$") %>% 
#   distinct(aamc_id, name, .keep_all = TRUE) %>% 
#   select(-appl_person_id, -appl_year, -aamc_id, -name, -appl_year)

#write data
write_csv(parents_raw_deid, "/Volumes/admissions/data_for_itai/parents_raw_deidentified.csv")
# write_csv(parents_clean_deid, "/Volumes/admissions/data_for_itai/parents_clean_deidentified.csv")

```


```{r}
map(dbListConnections(MySQL()), dbDisconnect)
```
