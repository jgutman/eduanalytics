---
title: "Education Analytics Admissions Screening Project"
author: "Jacqueline Gutman, Suvam Paul"
date: 'Last updated: `r format(Sys.Date(), "%B %d, %Y") ` '
output:
  html_document:
    toc: yes
    toc_depth: '4'
  html_notebook:
    highlight: tango
    theme: cosmo
    toc: yes
    toc_depth: 4
subtitle: Connection to edu_analytics database
---

# Setup

## Load packages

```{r, message=FALSE}
library(tidyverse)
library(knitr)
library(RMySQL)
library(yaml)
library(tidyverse)
library(magrittr)
library(knitr)
library(stringr)
library(purrr)

sessionInfo()$otherPkgs %>%
  map_chr(function(pkg) paste(pkg$Package, pkg$Version)) %>%
  cat(sep = "\n")
opts_chunk$set(message = FALSE, warning = FALSE, comment = "   ",
            cache = TRUE, autodep = TRUE, cache.comments = FALSE)

```

## Read in database credentials and open connection

```{r, echo=FALSE}
#credentials_path <- "/Volumes/IIME/EDS/data/admissions/db_credentials/"
credentials_path <- "/Volumes/IIME/IIME/EDS/data/admissions/db_credentials/"
credentials_file <- "owner_credentials.yaml"
credentials <- paste0(credentials_path, credentials_file) %>%
  yaml::yaml.load_file()

edu_db_con <- dbConnect(MySQL(),
        user = credentials$user,
        password = credentials$password,
        dbname = credentials$dbname,
        host = credentials$host,
        port = credentials$port)

edu_db <- src_sql("mysql", edu_db_con, info = dbGetInfo(edu_db_con))

# edu_db <- src_mysql(credentials$dbname,
#                     host = credentials$host,
#                     port = credentials$port,
#                     user = credentials$user,
#                     password = credentials$password)


rm(credentials)
```

# Admissions applicants datasets: 2013-2016

## Read in all_applicants tables from database

```{r}
(table_names <- db_list_tables(edu_db$con))


table_names %>%
  str_detect(regex("^\\identified\\Wraw\\W\\d{4}_all_applicants$", ignore_case = TRUE)) %>%
  which() %>%
  extract(table_names, .) %>%
  purrr::map(., function(tbl_name) tbl(edu_db, tbl_name)) %>%
  purrr::map(., function(x) collect(x)) %>%
  map(function(df) set_names(df, str_replace_all(colnames(df), " ", "_"))) %>%
  map(function(df) set_names(df, tolower(colnames(df)))) %>%
  set_names(2013:2016) -> applicants_data
```

```{r}
# filter out irrelevant and identifying columns
cols_to_keep <- read_lines("cols_to_keep_admissions.yaml")
applicants_data %<>% 
  map(function(df) select_(df, .dots = cols_to_keep))
```

```{r}
# check that all columns and coltypes are the same for all application years

is_single_value <- . %>% 
  flatten_chr() %>%
  n_distinct() %>%
  equals(1)

applicants_data %>% 
  at_depth(2, typeof) -> coltypes

coltypes %>% 
  as_data_frame() %>% 
  mutate_all(flatten_chr) -> coltypes_df

coltypes %>% 
  map(names) %>% 
  as_data_frame() %>% 
  by_row(is_single_value, .collate = "rows", .to = "col_names_match") %>% 
  use_series(col_names_match) %>%
  all()

coltypes %>% 
  extract2(1) %>% 
  names() %>%
  mutate(coltypes_df, colname = .) %>%
  select(colname, everything()) %>%
  by_row(function(a) is_single_value(a[-1]), .collate = "rows", .to = "col_types_match") ->
  coltypes_df

coltypes_df %>% use_series(col_types_match) %>% all()
```

```{r}
applicants_all_years <- bind_rows(applicants_data)
colnames(applicants_all_years)
```

```{r, eval = FALSE}
# write deidentified data to file
deidentified_output <- "/Volumes/IIME/EDS/data/admissions/data_for_itai/"

applicants_all_years %>%
  write_csv(paste0(deidentified_output, "admissions_all_applicants_deidentified.csv"))
```


# Raw features from eduDW tables

```{r}
# 
# make_data_frame <- function(tables_list, pattern) {
#   tables_list %>%
#     str_detect(regex(pattern, ignore_case = TRUE)) %>%
#     which() %>%
#     extract(tables_list, .) %>% 
#     tbl(edu_db, .) %>% 
#     as.data.frame() %>% 
#     set_colnames(tolower(colnames(.)))
# }

```


## Ethnicity

```{r, ethnicity, echo=FALSE}

(table_names <- db_list_tables(edu_db_con))

#write to database

#deidentified_raw
table_names %>% 
  str_detect(regex("^hashed\\Wraw\\Wethnicity$", ignore.case = TRUE)) %>% 
  which() %>% 
  extract(table_names, .) %>% 
  tbl(edu_db, .) %>%
  select(-appl_person_id, -aamc_id) %>% 
  collect(n=Inf) %>% 
  dbWriteTable(edu_db_con, "deidentified$raw$ethnicity", ., overwrite = TRUE, row.names = FALSE)


#deidentfied_clean
table_names %>% 
  str_detect(regex("^deidentified\\Wraw\\Wethnicity$", ignore.case = TRUE)) %>% 
  which() %>% 
  extract(table_names, .) %>% 
  tbl(edu_db, .) %>% 
  collect(n=Inf) %>% 
  filter(appl_year == 2013 | appl_year == 2014 | appl_year == 2015 | appl_year == 2016  | appl_year == 2017) %>%
  distinct(study_id, ethnicity, .keep_all = TRUE) %>%
  select(-appl_year) %>%
  dbWriteTable(edu_db_con, "deidentified$clean$ethnicity", ., overwrite = TRUE, row.names = FALSE)



# ethnicity_raw_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wraw\\Wethnicity$") %>% 
#   select(-(appl_person_id), -(aamc_id))

# ethnicity_clean_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wclean\\Wethnicity$") %>% 
#   select(-(appl_person_id), -(aamc_id))

# write data
# write_csv(ethnicity_raw_deid, "/Volumes/admissions/data_for_itai/ethnicity_raw_deidentified.csv")
# write_csv(ethnicity_clean_deid, "/Volumes/admissions/data_for_itai/ethnicity_clean_deidentified.csv")
```



## Race

```{r, race, echo=FALSE}

(table_names <- db_list_tables(edu_db_con))

#deidentfied_raw
table_names %>% 
  str_detect(regex("^hashed\\Wraw\\Wrace$", ignore.case = TRUE)) %>% 
  which() %>% 
  extract(table_names, .) %>% 
  tbl(edu_db, .) %>%
  select(-appl_person_id, -aamc_id) %>% 
  collect(n=Inf) %>% 
  dbWriteTable(edu_db_con, "deidentified$raw$race", ., overwrite = TRUE, row.names = FALSE)

#deidentfied_clean
table_names %>% 
  str_detect(regex("^deidentified\\Wraw\\Wrace$", ignore.case = TRUE)) %>% 
  which() %>% 
  extract(table_names, .) %>% 
  tbl(edu_db, .) %>% 
  collect(n=Inf) %>% 
  filter(appl_year == 2013 | appl_year == 2014 | appl_year == 2015 | appl_year == 2016  | appl_year == 2017) %>%
  distinct(study_id, race, .keep_all = TRUE) %>%
  select(-appl_year) %>%
  dbWriteTable(edu_db_con, "deidentified$clean$race", ., overwrite = TRUE, row.names = FALSE)

# race_raw_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wraw\\Wrace$") %>% 
#   select(-(appl_person_id), -(aamc_id))

# race_clean_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wclean\\Wrace$") %>% 
#   select(-(appl_person_id), -(aamc_id))

# write data
# write_csv(race_raw_deid, "/Volumes/admissions/data_for_itai/race_raw_deidentified.csv")
# write_csv(race_clean_deid, "/Volumes/admissions/data_for_itai/race_clean_deidentified.csv")

```


## School

```{r, schools, echo=FALSE}

(table_names <- db_list_tables(edu_db_con))

#deidentfied_raw
table_names %>% 
  str_detect(regex("^hashed\\Wraw\\Wschool$", ignore.case = TRUE)) %>% 
  which() %>% 
  extract(table_names, .) %>% 
  tbl(edu_db, .) %>%
  select(-appl_person_id, -aamc_id) %>% 
  collect(n=Inf) %>% 
  dbWriteTable(edu_db_con, "deidentified$raw$school", ., overwrite = TRUE, row.names = FALSE)


#deidentided_clean
table_names %>% 
  str_detect(regex("^deidentified\\Wraw\\Wschool$", ignore.case = TRUE)) %>% 
  which() %>% 
  extract(table_names, .) %>% 
  tbl(edu_db, .) %>% 
  collect(n=Inf) %>% 
  filter(appl_year == 2013 | appl_year == 2014 | appl_year == 2015 | appl_year == 2016  | appl_year == 2017) %>%
  distinct(study_id, mod_school_desc, program_type_desc, .keep_all = TRUE) %>%
  dbWriteTable(edu_db_con, "deidentified$clean$school", ., overwrite = TRUE, row.names = FALSE)


# schools_raw_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wraw\\Wschool$") %>% 
#   select(-(appl_person_id), -(aamc_id))


# schools_clean_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wclean\\Wschool$") %>%
#   select(-(appl_person_id), -(aamc_id))
  
# write data
# write_csv(schools_raw_deid, "/Volumes/admissions/data_for_itai/schools_raw_deidentified.csv")
# write_csv(schools_clean_deid, "/Volumes/admissions/data_for_itai/schools_clean_deidentified.csv")

```

## GPA

```{r, gpa, echo=FALSE}


(table_names <- db_list_tables(edu_db_con))


#deidentfied_raw
table_names %>% 
  str_detect(regex("^hashed\\Wraw\\Wgpa$", ignore.case = TRUE)) %>% 
  which() %>% 
  extract(table_names, .) %>% 
  tbl(edu_db, .) %>%
  select(-appl_person_id, -aamc_id) %>% 
  collect(n=Inf) %>% 
  dbWriteTable(edu_db_con, "deidentified$raw$gpa", ., overwrite = TRUE, row.names = FALSE)


#deidentified_clean
table_names %>% 
  str_detect(regex("^deidentified\\Wraw\\Wgpa$", ignore.case = TRUE)) %>% 
  which() %>% 
  extract(table_names, .) %>% 
  tbl(edu_db, .) %>%
  collect(n=Inf) %>% 
  filter(appl_year == 2013 | appl_year == 2014 | appl_year == 2015 | appl_year == 2016  | appl_year == 2017) %>%
  distinct(study_id, aca_status_desc, .keep_all = TRUE) %>%
  dbWriteTable(edu_db_con, "deidentified$clean$gpa", ., overwrite = TRUE, row.names = FALSE)

# gpa_raw_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wraw\\Wgpa$") %>% 
#   select(-appl_person_id, -aamc_id)

# gpa_clean_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wclean\\Wgpa$") %>% 
#   select(-appl_person_id, -aamc_id)

# write data
# write_csv(gpa_raw_deid, "/Volumes/admissions/data_for_itai/gpa_raw_deidentified.csv")
# write_csv(gpa_clean_deid, "/Volumes/admissions/data_for_itai/gpa_clean_deidentified.csv")

```

## MMI

```{r, mmi, echo = FALSE}

(table_names <- db_list_tables(edu_db_con))


#deidentfied_raw
table_names %>% 
  str_detect(regex("^hashed\\Wraw\\Wmmi_scores$", ignore.case = TRUE)) %>% 
  which() %>% 
  extract(table_names, .) %>% 
  tbl(edu_db, .) %>%
  select(-application_id, -amcas_id, -appl_person_id, -fac_last_name, -fac_first_name,
        -comment, -avg, -stdev, -conflict, -interview_id, -scenario, -interview_type, -interview_type,
        -faculty_id, -code, -mmi_question_id) %>% 
  collect(n=Inf) %>% 
  dbWriteTable(edu_db_con, "deidentified$raw$mmi_scores", ., overwrite = TRUE, row.names = FALSE)



#deidentfied_clean
table_names %>% 
  str_detect(regex("^deidentified\\Wraw\\Wmmi_scores$", ignore.case = TRUE)) %>% 
  which() %>% 
  extract(table_names, .) %>% 
  tbl(edu_db, .) %>%
  collect(n=Inf) %>% 
  filter(app_year != 2013) %>%
  dbWriteTable(edu_db_con, "deidentified$clean$mmi_scores", ., overwrite = TRUE, row.names = FALSE)



# mmi_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wraw\\Wmmi_scores$") %>% 
#   select(-application_id, -amcas_id, -appl_person_id, -fac_last_name, -fac_first_name, 
#          -comment, -avg, -stdev, -conflict, -interview_id, -scenario, -interview_type, -interview_type, 
#          -faculty_id, -code, -mmi_question_id)
# 
# write_csv(mmi_deid, "/Volumes/admissions/data_for_itai/mmi_deidentified.csv")

```


## MCAT: OLD

```{r, mcat_old, echo=FALSE}

(table_names <- db_list_tables(edu_db_con))


#deidentfied_raw
table_names %>% 
  str_detect(regex("^hashed\\Wraw\\Wold_mcat$", ignore.case = TRUE)) %>% 
  which() %>% 
  extract(table_names, .) %>% 
  tbl(edu_db, .) %>%
  select(-appl_person_id, -aamc_id) %>% 
  collect(n=Inf) %>% 
  dbWriteTable(edu_db_con, "deidentified$raw$old_mcat", ., overwrite = TRUE, row.names = FALSE)



#deidentfied_clean
table_names %>% 
  str_detect(regex("^deidentified\\Wraw\\Wold_mcat$", ignore.case = TRUE)) %>% 
  which() %>% 
  extract(table_names, .) %>% 
  tbl(edu_db, .) %>%
  collect(n=Inf) %>% 
  filter(appl_year == 2013 | appl_year == 2014 | appl_year == 2015 | appl_year == 2016  | appl_year == 2017) %>%
  mutate(test_date = lubridate::ymd(test_date)) %>%
  distinct(study_id, test_date, .keep_all = TRUE) %>% 
  dbWriteTable(edu_db_con, "deidentified$clean$old_mcat", ., overwrite = TRUE, row.names = FALSE)

# oldmcat_raw_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wraw\\Wold_mcat$") %>% 
#   set_colnames(stringr::str_replace(colnames(.), "_p$", "_percentile")) %>% 
#   select(-appl_person_id, -aamc_id)

# oldmcat_clean_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wclean\\Wmmi_scores$") %>% 
#   select(-appl_person_id, -aamc_id)

# write data
# write_csv(oldmcat_raw_deid, "/Volumes/admissions/data_for_itai/oldmcat_raw_deidentified.csv")
# write_csv(oldmcat_clean_deid, "/Volumes/admissions/data_for_itai/oldmcat_clean_deidentified.csv")
```

## MCAT: NEW

```{r, new_mcat, echo=FALSE}

(table_names <- db_list_tables(edu_db_con))

#deidentfied_raw
table_names %>% 
  str_detect(regex("^hashed\\Wraw\\Wnew_mcat$", ignore.case = TRUE)) %>% 
  which() %>% 
  extract(table_names, .) %>% 
  tbl(edu_db, .) %>%
  select(-appl_person_id, -aamc_id) %>% 
  collect(n=Inf) %>% 
  dbWriteTable(edu_db_con, "deidentified$raw$new_mcat", ., overwrite = TRUE, row.names = FALSE)


#deidentfied_clean
table_names %>% 
  str_detect(regex("^deidentified\\Wraw\\Wnew_mcat$", ignore.case = TRUE)) %>% 
  which() %>% 
  extract(table_names, .) %>% 
  tbl(edu_db, .) %>%
  collect(n=Inf) %>% 
  filter(appl_year == 2013 | appl_year == 2014 | appl_year == 2015 | appl_year == 2016  | appl_year == 2017) %>%
  mutate(new_mcat_test_date = lubridate::ymd(new_mcat_test_date)) %>%
  distinct(study_id, new_mcat_test_date, .keep_all = TRUE) %>% 
  dbWriteTable(edu_db_con, "deidentified$clean$new_mcat", ., overwrite = TRUE, row.names = FALSE)


# newmcat_raw_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wraw\\Wnew_mcat$") %>% 
#   select(-appl_person_id, -aamc_id)
  
# newmcat_clean_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wclean\\Wnew_mcat$") %>% 
#   select(-appl_person_id, -aamc_id)

# write data
# write_csv(newmcat_raw_deid, "/Volumes/admissions/data_for_itai/newmcat_raw_deidentified.csv")
# write_csv(newmcat_clean_deid, "/Volumes/admissions/data_for_itai/newmcat_clean_deidentified.csv")

```

## Parent/Guardian

```{r, parent_guardian, echo=FALSE}
(table_names <- db_list_tables(edu_db_con))

#deidentfied_raw
table_names %>% 
  str_detect(regex("^hashed\\Wraw\\Wparent_guardian$", ignore.case = TRUE)) %>% 
  which() %>% 
  extract(table_names, .) %>% 
  tbl(edu_db, .) %>%
  select(-appl_person_id, -aamc_id, -name, -living_ind) %>% 
  collect(n=Inf) %>% 
  dbWriteTable(edu_db_con, "deidentified$raw$parent_guardian", ., overwrite = TRUE, row.names = FALSE)



#deidentfied_clean
table_names %>% 
  str_detect(regex("^deidentified\\Wraw\\Wparent_guardian$", ignore.case = TRUE)) %>% 
  which() %>% 
  extract(table_names, .) %>% 
  tbl(edu_db, .) %>%
  collect(n=Inf) %>% 
  filter(appl_year == 2013 | appl_year == 2014 | appl_year == 2015 | appl_year == 2016  | appl_year == 2017) %>%
  distinct(study_id, occupation_desc, edu_level_desc, gender, .keep_all = TRUE) %>% 
  dbWriteTable(edu_db_con, "deidentified$clean$parent_guardian", ., overwrite = TRUE, row.names = FALSE)
  

# parents_raw_deid <- table_names %>% 
#   make_data_frame("^hashed\\Wclean\\Wparent_guardian$") %>% 
#   select(-appl_person_id, -appl_year, -aamc_id, -name, -living_ind)


#write data
# write_csv(parents_raw_deid, "/Volumes/admissions/data_for_itai/parents_raw_deidentified.csv")

```


```{r}
dbDisconnect(edu_db$con)
```
